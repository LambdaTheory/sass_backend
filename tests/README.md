# 测试说明

本项目使用 Jest 作为测试框架，提供完整的单元测试覆盖。

## 运行测试

```bash
# 运行所有测试
npm test

# 监听模式运行测试
npm run test:watch

# 生成测试覆盖率报告
npm run test:coverage
```

## 测试结构

- `tests/setup.ts` - 测试环境配置
- `tests/middleware/` - 中间件测试
  - `permission.middleware.test.ts` - 权限中间件测试

## 权限中间件测试

权限中间件测试覆盖了以下场景：

### 用户状态检查
- ✅ 拒绝未登录用户
- ✅ 拒绝被禁用的用户（status !== 1）
- ✅ 允许正常状态的用户

### 权限检查
- ✅ 超级管理员拥有所有权限
- ✅ 检查单个权限
- ✅ 检查多个权限（OR逻辑）
- ✅ 检查多个权限（AND逻辑）

### 角色检查
- ✅ 检查用户角色匹配
- ✅ 支持多角色检查

### 商户访问控制
- ✅ 用户只能访问自己商户的资源
- ✅ 超级管理员可以访问所有商户资源
- ✅ 商户ID验证

## 重要更新

### 用户禁用状态检查

在本次更新中，我们为所有权限中间件添加了用户状态检查：

- `requirePermission` - 检查用户权限前先验证用户状态
- `requireRole` - 检查用户角色前先验证用户状态  
- `requireMerchantAccess` - 检查商户访问权限前先验证用户状态

这确保了即使用户的JWT token仍然有效，但如果用户被管理员禁用（status !== 1），下次请求时会被立即拒绝访问。

### 安全性提升

通过在权限检查层面添加用户状态验证，我们提供了额外的安全保障：

1. **实时状态检查** - 每次请求都会检查用户当前状态
2. **即时生效** - 用户被禁用后立即生效，无需等待token过期
3. **多层防护** - 认证层和权限层都进行状态检查

这种设计确保了系统的安全性和管理的及时性。